<html>

  <head>
  </head>
  <body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.0/lodash.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="//js.pusher.com/2.2/pusher.min.js"></script>
    <script type="text/javascript">
      function mapRange(from, to, x) {
        return to[0] + ( x - from[0] ) * (to[1] - to[0]) / (from[1] - from[0]);
      }

      window.onload = function() {

        // WEB AUDIO SETUP
        var audioCtx = new AudioContext();

        // soundCtrl plays sounds and changes them based on the data you give
        // it with soundCtrl.update(data), where data is a number
        var soundCtrl = (function() {

          var tone = audioCtx.createOscillator();
          tone.type = "triangle";
          tone.frequency.value = 0;

          var gain = audioCtx.createGain();
          gain.gain.value = 0.5;

          tone.connect(gain);
          gain.connect(audioCtx.destination);
          tone.start(0);

          var prev_d = null;

          function update(d) {
            var freq = mapRange([0.0, 4.0], [0, 1000], d);
            console.log('\tfrequency', freq);
            tone.frequency.value = freq;

            var diff = prev_d === null ? 0 : (d - prev_d) / prev_d;
            var newgain = 0.5 + diff*3;
            console.log('\tgain', newgain);
            gain.gain.value = newgain;
            gain.gain.value = Math.max(Math.min(gain.gain.value, 1), 0);

            prev_d = d;
          }

          return {
            update: update,
          };
        })();

        // GETTING THE GSR VALUES
        // see the producer/neulog.py file
        var key = 'd5d9a0bbf3ee745375ba';
        var faucet = new Pusher(key, {encrypted:true}).subscribe('everything');
        var left = 0; // the starting left position of the bar graph
        var w = 1; // the width of every bar in our graph

        faucet.bind('neulogGSR', function (data) {
          // average GSR value for that short time period
          var gsr = _.sum(data.data.buffer) / data.data.buffer.length;
          console.log('gsr', gsr);
          soundCtrl.update(gsr);

          // visualization
          var h = gsr * 50;
          $('body').append('<div style="left:'+left+'px; bottom:0; background:rgb(99,210,167); width:'+w+'px; position: absolute; height:'+h+'px;"></div>');
          left += 1;
        });

      }

    </script>
  </body>
</html>
